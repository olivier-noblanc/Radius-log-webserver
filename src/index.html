<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radius Log Viewer - Live</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .cursor-pointer { cursor: pointer; }
        .sort-icon::after { content: ' ↕'; opacity: 0.3; }
        .sort-asc::after { content: ' ↑'; opacity: 1; }
        .sort-desc::after { content: ' ↓'; opacity: 1; }
        .live-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background-color: grey; }
        .live-active { background-color: #28a745; box-shadow: 0 0 5px #28a745; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }
    </style>
</head>
<body class="bg-body-tertiary">
    <nav class="navbar navbar-expand-lg border-bottom bg-body">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-shield-check"></i> Radius Viewer</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showView('logs')">Logs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('dashboard')">Dashboard</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-secondary" id="connectionStatus">Disconnected</span>
                    <button class="btn btn-outline-primary btn-sm" id="themeToggle"><i class="bi bi-moon"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4" id="view-dashboard" style="display: none;">
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Rejets par Heure</div>
                    <div class="card-body">
                        <canvas id="chartRejects"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Top Utilisateurs</div>
                    <div class="card-body">
                        <canvas id="chartUsers"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4" id="view-logs">
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-4">
                        <select id="fileSelect" class="form-select">
                            <option value="">Chargement...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="searchInput" class="form-control" placeholder="Recherche (User, MAC, IP...)">
                    </div>
                    <div class="col-md-3">
                         <div class="btn-group w-100" role="group">
                            <button id="loadBtn" class="btn btn-primary"><i class="bi bi-arrow-clockwise"></i> Charger</button>
                            <button id="liveBtn" class="btn btn-outline-success"><div class="live-indicator me-2"></div>Live</button>
                         </div>
                    </div>
                    <div class="col-md-2">
                        <button id="exportBtn" class="btn btn-outline-secondary w-100"><i class="bi bi-download"></i> Export CSV</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive shadow-sm bg-body rounded">
            <table class="table table-hover table-bordered table-sm mb-0" id="logTable">
                <thead class="table-dark">
                    <tr>
                        <th class="cursor-pointer sortable" data-col="timestamp">Time <span class="sort-icon"></span></th>
                        <th class="cursor-pointer sortable" data-col="type">Type <span class="sort-icon"></span></th>
                        <th class="cursor-pointer sortable" data-col="server">Server <span class="sort-icon"></span></th>
                        <th class="cursor-pointer sortable" data-col="ap_ip">Client IP <span class="sort-icon"></span></th>
                        <th class="cursor-pointer sortable" data-col="ap_name">Client Name <span class="sort-icon"></span></th>
                        <th class="cursor-pointer sortable" data-col="mac">MAC <span class="sort-icon"></span></th>
                        <th class="cursor-pointer sortable" data-col="user">User <span class="sort-icon"></span></th>
                        <th class="cursor-pointer sortable" data-col="resp_type">Response <span class="sort-icon"></span></th>
                        <th class="cursor-pointer sortable" data-col="reason">Reason <span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody class="align-middle">
                    <!-- Data -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Détails -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Détails de la requête</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="modalContent" class="bg-light p-3 border rounded"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Dark Mode ---
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            const html = document.documentElement;
            const current = html.getAttribute('data-bs-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', next);
            themeToggle.innerHTML = next === 'dark' ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>';
        });

        // --- WebSocket ---
        let socket;
        let isLive = false;
        const liveBtn = document.getElementById('liveBtn');
        const indicator = document.querySelector('.live-indicator');
        const connectionStatus = document.getElementById('connectionStatus');

        function connectWs() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/ws`);

            socket.onopen = () => {
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'badge bg-success';
            };

            socket.onmessage = (event) => {
                if (!isLive) return;
                const newRows = JSON.parse(event.data);
                // Prepend new rows
                const tbody = document.querySelector('#logTable tbody');
                newRows.forEach(row => {
                    const tr = createRow(row);
                    tr.classList.add('table-warning'); // Highlight new
                    tbody.insertBefore(tr, tbody.firstChild);
                    setTimeout(() => tr.classList.remove('table-warning'), 2000);
                });
            };

            socket.onclose = () => {
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'badge bg-danger';
                setTimeout(connectWs, 3000); // Reconnect
            };
        }

        liveBtn.addEventListener('click', () => {
            isLive = !isLive;
            if (isLive) {
                indicator.classList.add('live-active');
                liveBtn.classList.remove('btn-outline-success');
                liveBtn.classList.add('btn-success');
            } else {
                indicator.classList.remove('live-active');
                liveBtn.classList.add('btn-outline-success');
                liveBtn.classList.remove('btn-success');
            }
        });

        connectWs();

        // --- Main Logic ---
        const fileSelect = document.getElementById('fileSelect');
        const loadBtn = document.getElementById('loadBtn');
        const searchInput = document.getElementById('searchInput');
        const tbody = document.querySelector('#logTable tbody');
        const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        let currentSort = { col: 'timestamp', desc: true };

        // Helper: Create Row
        function createRow(row) {
            const tr = document.createElement('tr');
            if (row.bg_color_class) tr.classList.add(row.bg_color_class);
            tr.innerHTML = `
                <td>${row.timestamp}</td>
                <td>${row.req_type}</td>
                <td>${row.server}</td>
                <td>${row.ap_ip}</td>
                <td>${row.ap_name}</td>
                <td>${row.mac}</td>
                <td>${row.user}</td>
                <td>${row.resp_type}</td>
                <td>${row.reason}</td>
            `;
            tr.addEventListener('click', () => showDetails(row));
            tr.style.cursor = 'pointer';
            return tr;
        }

        function showDetails(row) {
            document.getElementById('modalContent').textContent = JSON.stringify(row, null, 2);
            modal.show();
        }

        // Load Files
        fetch('/api/files').then(r => r.json()).then(files => {
            fileSelect.innerHTML = '';
            if (files.length === 0) {
                 fileSelect.innerHTML = '<option>Aucun fichier</option>';
                 return;
            }
            files.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.path;
                opt.textContent = `${f.name} (${(f.size/1024).toFixed(1)} KB)`;
                fileSelect.appendChild(opt);
            });
            // Auto load first
            if(files.length > 0) loadData();
        });

        function loadData() {
            const path = fileSelect.value;
            if(!path || path.startsWith("Aucun")) return;

            const search = searchInput.value;
            const sort = currentSort.col;
            const desc = currentSort.desc;

            tbody.innerHTML = '<tr><td colspan="9" class="text-center"><div class="spinner-border text-primary"></div></td></tr>';

            fetch(`/api/parse?file=${encodeURIComponent(path)}&search=${encodeURIComponent(search)}&sort_by=${sort}&sort_desc=${desc}`)
                .then(r => r.json())
                .then(data => {
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center">Aucun résultat</td></tr>';
                        return;
                    }
                    data.forEach(row => tbody.appendChild(createRow(row)));
                    updateSortIcons();
                });
        }

        // Sort
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.col;
                if (currentSort.col === col) currentSort.desc = !currentSort.desc;
                else { currentSort.col = col; currentSort.desc = true; }
                loadData();
            });
        });

        function updateSortIcons() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.col === currentSort.col) th.classList.add(currentSort.desc ? 'sort-desc' : 'sort-asc');
            });
        }

        loadBtn.addEventListener('click', loadData);
        let timeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(loadData, 500);
        });

        // Export
        document.getElementById('exportBtn').addEventListener('click', () => {
            const path = fileSelect.value;
            const search = searchInput.value;
            if(!path) return;
            window.location.href = `/api/export?file=${encodeURIComponent(path)}&search=${encodeURIComponent(search)}`;
        });

        // --- View Switching ---
        window.showView = function(viewName) {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById('view-logs').style.display = 'none';
            document.getElementById('view-dashboard').style.display = 'none';

            if(viewName === 'logs') {
                document.getElementById('view-logs').style.display = 'block';
                event.target.classList.add('active');
            } else if (viewName === 'dashboard') {
                document.getElementById('view-dashboard').style.display = 'block';
                event.target.classList.add('active');
                initCharts();
            }
        };

        // --- Charts ---
        let chartsInitialized = false;
        function initCharts() {
            if(chartsInitialized) return;
            
            fetch('/api/stats').then(r => r.json()).then(stats => {
                // Rejets
                new Chart(document.getElementById('chartRejects'), {
                    type: 'line',
                    data: {
                        labels: stats.rejections_by_hour.map(x => x[0]),
                        datasets: [{
                            label: 'Rejets',
                            data: stats.rejections_by_hour.map(x => x[1]),
                            borderColor: 'red',
                            tension: 0.1
                        }]
                    }
                });
                
                // Users (Dummy logic for now as API returns minimal)
                new Chart(document.getElementById('chartUsers'), {
                    type: 'bar',
                    data: {
                        labels: stats.top_users ? stats.top_users.map(x => x[0]) : ['User A', 'User B'],
                        datasets: [{
                            label: 'Echecs',
                            data: stats.top_users ? stats.top_users.map(x => x[1]) : [10, 5],
                            backgroundColor: '#36a2eb'
                        }]
                    }
                });
                chartsInitialized = true;
            });
        }
    </script>
</body>
</html>
